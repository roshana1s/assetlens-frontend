import React, { useState, useEffect } from "react";
import { NavLink, useLocation, useNavigate } from "react-router-dom";
import { Dropdown } from "react-bootstrap";
import "bootstrap/dist/css/bootstrap.min.css";
import "./NavBarOrgAdmin.css";
import axios from "axios";
import { useAuth } from "../../context/AuthContext";
import { useNotifications } from "../../context/NotificationContext";
import { useAlerts } from "../../context/AlertContext";

const NavBarOrgAdmin = () => {
    const [showAlerts, setShowAlerts] = useState(false);
    const [showProfile, setShowProfile] = useState(false);
    const [profileData, setProfileData] = useState(null);
    const [assets, setAssets] = useState({});
    const [floors, setFloors] = useState({});
    const [zones, setZones] = useState({});
    const [loadingAssets, setLoadingAssets] = useState(false);

    const { user, isGlobalAdmin, currentOrgId, logout } = useAuth();
    const navigate = useNavigate();
    const location = useLocation();
    const isConfigActive = location.pathname.startsWith("/admin/config");

    const {
        notifications,
        unreadCount,
        loading: loadingNotifications,
        error: notificationError,
        markAllAsRead
    } = useNotifications();

    const [showNotifications, setShowNotifications] = useState(false);
    const {
        alerts,
        unreadAlertCount,
        loading: loadingAlerts,
        error: alertError,
        markAllAlertsAsRead
    } = useAlerts();

    useEffect(() => {
    if (showNotifications && unreadCount > 0) {
        markAllAsRead();
    }
}, [showNotifications]);

    useEffect(() => {
        const fetchProfileData = async () => {
            try {
                const response = await axios.get("http://localhost:8000/user/profile", {
                    headers: {
                        Authorization: `Bearer ${localStorage.getItem("token")}`,
                    },
                });
                setProfileData(response.data);
            } catch (error) {
                console.error("Error fetching profile data:", error);
            }
        };

        if (showProfile) {
            fetchProfileData();
        }
    }, [showProfile]);

    useEffect(() => {
        const fetchAssetAndLocationData = async () => {
            if (showAlerts && currentOrgId) {
                try {
                    setLoadingAssets(true);


                    const assetsRes = await axios.get(`http://localhost:8000/assets/${currentOrgId}`);
                    const assetsMap = {};
                    assetsRes.data.forEach(asset => {
                        assetsMap[asset.asset_id] = asset;
                    });
                    setAssets(assetsMap);

                    const uniqueFloors = [...new Set(alerts.map(a => a.floor_id))];
                    const floorPromises = uniqueFloors.map(floorId =>
                        axios.get(`http://localhost:8000/maps/${currentOrgId}/get-floor/${floorId}`)
                    );

                    const floorsData = await Promise.all(floorPromises);
                    const floorsMap = {};
                    const zonesMap = {};

                    floorsData.forEach(floor => {
                        floorsMap[floor.data.floor_id] = floor.data.floorName;
                        floor.data.zones.forEach(zone => {
                            zonesMap[zone.zone_id] = zone.name;
                        });
                    });

                    setFloors(floorsMap);
                    setZones(zonesMap);

                } catch (err) {
                    console.error("Error fetching asset/location data:", err);
                } finally {
                    setLoadingAssets(false);
                }
            }
        };

        fetchAssetAndLocationData();
    }, [showAlerts, currentOrgId, alerts]);

    const toggleAlerts = () => {
        const newState = !showAlerts;
        setShowAlerts(newState);
        setShowNotifications(false);
        setShowProfile(false);
    };

    const getAlertColor = (type) => {
        switch(type) {
            case 'misplaced': return '#ff4444'
            case 'geofence_breach': return '#9c3106';
            case 'potential_geofence_breach': return '#525049';
            default: return '#000000';
        }
    };


    const formatDescription = (alert) => {
        const assetName = assets[alert.asset_id]?.name || alert.asset_id;
        const floorName = floors[alert.floor_id] || alert.floor_id;
        const zoneName = zones[alert.zone_id] || alert.zone_id;

        const getColoredText = (text, type) => {
        const color = getAlertColor(type);
        return <span style={{ color }}>{text}</span>;
    };

        switch(alert.type) {
        case 'geofence_breach':
            return (
                <>
                    {getColoredText(`${assetName} left its assigned zone ${zoneName}`, 'geofence_breach')}
                    {` on ${floorName}`}
                </>
            );
        case 'potential_geofence_breach':
            return (
                <>
                    {getColoredText(`${assetName} is approaching the boundary of ${zoneName}`, 'potential_geofence_breach')}
                    {` on ${floorName}`}
                </>
            );
        case 'misplaced':
            return getColoredText(
                `${assetName} was placed in ${zoneName} on ${floorName} (unexpected location)`,
                'misplaced'
            );
        default:
            return alert.description
                .replace(alert.asset_id, assetName)
                .replace(alert.floor_id, floorName)
                .replace(alert.zone_id, zoneName);
    }
    };

    const formatTime = (timestamp) => {
        return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    };

    const toggleNotifications = () => {
        const newState = !showNotifications;
        setShowNotifications(newState);
        setShowAlerts(false);
        setShowProfile(false);

        if (newState && unreadCount > 0) {
            markAllAsRead();
        }
    };

    const toggleProfile = () => {
        setShowNotifications(false);
        setShowAlerts(false);
        setShowProfile(!showProfile);
    };

    const handleLogout = () => {
        logout();
        navigate("/login");
    };

    return (
        <div className="layout-container">
            <nav className="navbar-custom">
                <div className="brand">
                    {/* <img src="/logo.png" alt="logo" className="logo" /> */}
                    <span className="brand-name">AssetLens</span>
                </div>
                <div className="nav-links">
                    <NavLink
                        to={`/dashboard/org/${currentOrgId}/admin/online-tracking`}
                        className={({ isActive }) =>
                            isActive ? "nav-link active" : "nav-link"
                        }
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-geo-alt"
                            viewBox="0 0 16 16"
                        >
                            <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10" />
                            <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                        </svg>
                        &nbsp;Online tracking
                    </NavLink>

                    <NavLink
                        to={`/dashboard/org/${currentOrgId}/admin/past-tracking`}
                        className={({ isActive }) =>
                            isActive ? "nav-link active" : "nav-link"
                        }
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-clock-history"
                            viewBox="0 0 16 16"
                        >
                            <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022zm2.004.45a7 7 0 0 0-.985-.299l.219-.976q.576.129 1.126.342zm1.37.71a7 7 0 0 0-.439-.27l.493-.87a8 8 0 0 1 .979.654l-.615.789a7 7 0 0 0-.418-.302zm1.834 1.79a7 7 0 0 0-.653-.796l.724-.69q.406.429.747.91zm.744 1.352a7 7 0 0 0-.214-.468l.893-.45a8 8 0 0 1 .45 1.088l-.95.313a7 7 0 0 0-.179-.483m.53 2.507a7 7 0 0 0-.1-1.025l.985-.17q.1.58.116 1.17zm-.131 1.538q.05-.254.081-.51l.993.123a8 8 0 0 1-.23 1.155l-.964-.267q.069-.247.12-.501m-.952 2.379q.276-.436.486-.908l.914.405q-.24.54-.555 1.038zm-.964 1.205q.183-.183.35-.378l.758.653a8 8 0 0 1-.401.432z" />
                            <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0z" />
                            <path d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5" />
                        </svg>
                        &nbsp;Past tracking
                    </NavLink>

                    <NavLink
                        to={`/dashboard/org/${currentOrgId}/admin/logs`}
                        className={({ isActive }) =>
                            isActive ? "nav-link active" : "nav-link"
                        }
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-journal-text"
                            viewBox="0 0 16 16"
                        >
                            <path d="M5 10.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0-2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5" />
                            <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2" />
                            <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1z" />
                        </svg>
                        &nbsp;Logs
                    </NavLink>

                    <NavLink
                        to="/admin/dashboard"
                        className={({ isActive }) =>
                            isActive ? "nav-link active" : "nav-link"
                        }
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-grid"
                            viewBox="0 0 16 16"
                        >
                            <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z" />
                        </svg>
                        &nbsp;Dashboard
                    </NavLink>

                    <Dropdown>
                        <Dropdown.Toggle
                            variant="outline-link"
                            className={
                                isConfigActive ? "nav-link active" : "nav-link"
                            }
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                fill="currentColor"
                                class="bi bi-gear"
                                viewBox="0 0 16 16"
                            >
                                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0" />
                                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z" />
                            </svg>
                            &nbsp;Configuration
                        </Dropdown.Toggle>
                        <Dropdown.Menu className="dropdown-menu">
                            <NavLink
                                to={`/dashboard/org/${currentOrgId}/admin/config-user`}
                                className="nav-link"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    class="bi bi-people"
                                    viewBox="0 0 16 16"
                                >
                                    <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1zm-7.978-1L7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002-.014.002zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0M6.936 9.28a6 6 0 0 0-1.23-.247A7 7 0 0 0 5 9c-4 0-5 3-5 4q0 1 1 1h4.216A2.24 2.24 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816M4.92 10A5.5 5.5 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0m3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4" />
                                </svg>
                                &nbsp; User Configuration
                            </NavLink>
                            <NavLink
                                to={`/dashboard/org/${currentOrgId}/admin/config-asset`}
                                className="nav-link"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    class="bi bi-suitcase-lg"
                                    viewBox="0 0 16 16"
                                >
                                    <path d="M5 2a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2h3.5A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5H14a.5.5 0 0 1-1 0H3a.5.5 0 0 1-1 0h-.5A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2zm1 0h4a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1M1.5 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5H3V3zM15 12.5v-9a.5.5 0 0 0-.5-.5H13v10h1.5a.5.5 0 0 0 .5-.5m-3 .5V3H4v10z" />
                                </svg>
                                &nbsp; Asset Configuration
                            </NavLink>
                            <NavLink
                                to={`/dashboard/org/${currentOrgId}/admin/config-map`}
                                className="nav-link"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    class="bi bi-map"
                                    viewBox="0 0 16 16"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.5.5 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103M10 1.91l-4-.8v12.98l4 .8zm1 12.98 4-.8V1.11l-4 .8zm-6-.8V1.11l-4 .8v12.98z"
                                    />
                                </svg>
                                &nbsp; Map Configuration
                            </NavLink>
                            <NavLink
                                to={`/dashboard/org/${currentOrgId}/admin/config-camera`}
                                className="nav-link"
                            >
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    fill="currentColor"
                                    class="bi bi-camera"
                                    viewBox="0 0 16 16"
                                >
                                    <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4z" />
                                    <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5m0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7M3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0" />
                                </svg>
                                &nbsp; Cam Configuration
                            </NavLink>
                        </Dropdown.Menu>
                    </Dropdown>
                </div>

                <div className="nav-icons">
                    <div className="icon-wrapper" onClick={toggleAlerts}>
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            className="alert-icon"
                            viewBox="0 0 16 16"
                        >
                            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2" />
                        </svg>
                        {unreadAlertCount > 0 && (
                            <span className="alert-badge">{unreadAlertCount}</span>
                        )}
                        {showAlerts && (
                            <div className="popup-box alert-popup">
                                {loadingAlerts || loadingAssets ? (
                                    <div className="loading-alerts">Loading alerts...</div>
                                ) : alertError ? (
                                    <div className="alert-error">{alertError}</div>
                                ) : alerts.length > 0 ? (
                                    <>
                                        <div className="alert-header">
                                            <h4>Alerts</h4>
                                            <div className="alert-actions">
                                                <button
                                                    className="mark-all-read"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        markAllAsRead();
                                                    }}
                                                    disabled={unreadAlertCount === 0}
                                                >
                                                    Mark all as read
                                                </button>
                                                <NavLink
                                                    to={`/dashboard/org/${currentOrgId}/admin/alerts`}
                                                    className="view-all-link"
                                                    onClick={() => setShowAlerts(false)}
                                                >
                                                    View All
                                                </NavLink>
                                            </div>
                                        </div>
                                        <div className="alert-list">
                                            {alerts.slice(0, 5).map((alert, index) => (
                                                <div
    key={index}
    className="alert-item"
    style={{ borderLeft: `3px solid ${getAlertColor(alert.type)}` }}
>
    <div className="alert-icon-container">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill={getAlertColor(alert.type)}
            viewBox="0 0 16 16"
            className="alert-type-icon"
        >
            {alert.type === 'geofence_breach' && (
                <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5m.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2"/>
            )}
            {alert.type === 'potential_geofence_breach' && (
                <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
            )}
            {alert.type === 'misplaced' && (
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
            )}
        </svg>
    </div>
    <div className="alert-details">
        <div className="alert-message">
            {formatDescription(alert)}
        </div>
        <div className="alert-meta">
            <span className="alert-type">
                {alert.type.replace(/_/g, ' ')}
            </span>
            <span className="alert-time">
                {formatTime(alert.timestamp)}
            </span>
        </div>
    </div>
</div>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <div className="no-alerts">
                                        No new alerts
                                        <NavLink
                                            to="/alerts"
                                            className="view-all-link"
                                            onClick={() => setShowAlerts(false)}
                                        >
                                            View All Alerts
                                        </NavLink>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>


                   <div className="icon-wrapper" onClick={() => {
    toggleNotifications();
    if (unreadCount > 0) {
        markAllAsRead();
    }
}}>
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="16"
                        height="16"
                        fill="currentColor"
                        className="notification-icon"
                        viewBox="0 0 16 16"
                    >
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2m.995-14.901a1 1 0 1 0-1.99 0A5 5 0 0 0 3 6c0 1.098-.5 6-2 7h14c-1.5-1-2-5.902-2-7 0-2.42-1.72-4.44-4.005-4.901" />
                    </svg>
                    {unreadCount > 0 && (
                        <span className="notification-badge">{unreadCount}</span>
                    )}
                    {showNotifications && (
                        <div className="popup-box notification-popup">
                            {loadingNotifications ? (
                                <div className="loading-notifications">Loading notifications...</div>
                            ) : notificationError ? (
                                <div className="notification-error">{notificationError}</div>
                            ) : notifications.length > 0 ? (
                                <>
                                    <div className="notification-header">
                                        <h4>Notifications</h4>
                                        <div className="notification-actions">
                                            <button
                                                className="mark-all-read"
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    markAllAsRead();
                                                }}
                                                disabled={unreadCount === 0}
                                            >
                                                Mark all as read
                                            </button>
                                            <NavLink
                                                to={`/dashboard/org/${currentOrgId}/admin/notifications`}
                                                className="view-all-link"
                                                onClick={() => setShowNotifications(false)}
                                            >
                                                View All
                                            </NavLink>
                                        </div>
                                    </div>
                                    <div className="notification-list">
                                        {notifications.map((notification, index) => (
                                            <div
                                                key={index}
                                                className={`notification-item ${notification.is_read ? '' : 'unread'}`}
                                            >
                                                <div className="notification-message">
                                                    {notification.message}
                                                </div>
                                                <div className="notification-meta">
                                                    <span className="notification-type">
                                                        {notification.type.replace('_', ' ')}
                                                    </span>
                                                    <span className="notification-time">
                                                        {formatTime(notification.timestamp)}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <div className="no-notifications">
                                    No new notifications
                                    <NavLink
                                        to="/notifications"
                                        className="view-all-link"
                                        onClick={() => setShowNotifications(false)}
                                    >
                                        View All Notifications
                                    </NavLink>
                                </div>
                            )}
                        </div>
                    )}
                </div>

<div className="icon-wrapper" onClick={toggleProfile}>
                    {user?.image_link ? (
                        <img
                            src={user.image_link}
                            alt="Profile"
                            className="profile-image-navbar"
                            style={{ width: 32, height: 32, borderRadius: "50%", objectFit: "cover", border: "2px solid #2f6fed" }}
                        />
                    ) : (
                        <div className="profile-image-placeholder-navbar" style={{ width: 32, height: 32, borderRadius: "50%", background: "#e5e9fb", display: "flex", alignItems: "center", justifyContent: "center", fontWeight: "bold", color: "#2f6fed", border: "2px solid #2f6fed" }}>
                            {user?.name?.charAt(0).toUpperCase() || user?.username?.charAt(0).toUpperCase() || 'U'}
                        </div>
                    )}
                    {showProfile && (
                        <div className="profile-popup-box">
      <div className="profile-header">
        {user?.image_link ? (
          <img src={user.image_link} alt="Profile" className="profile-image" />
        ) : (
          <div className="profile-image-placeholder">
            {user?.name?.charAt(0).toUpperCase() || 'U'}
          </div>
        )}
        <div className="profile-info">
          <h5 className="profile-name">{user?.name || user?.username || 'User'}</h5>
          <p className="profile-role">
            {isGlobalAdmin ? 'AssetLens Admin' : user?.role || 'User'}
          </p>
          <p className="profile-email">{user?.email || ''}</p>
        </div>
      </div>
      <div className="profile-links">
        <NavLink
          to={
            isGlobalAdmin
              ? "/dashboard/assetlens/profile"
              : `/dashboard/org/${currentOrgId}/${user?.role === 'user' ? 'user' : 'admin'}/profile`
          }
          className="profile-link"
          onClick={() => setShowProfile(false)}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            className="bi bi-person"
            viewBox="0 0 16 16"
          >
            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664z"/>
          </svg>
          &nbsp; My Profile
        </NavLink>
        <button
          className="profile-link logout-btn"
          onClick={handleLogout}
        >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            width="16"
                                            height="16"
                                            fill="currentColor"
                                            className="bi bi-box-arrow-right"
                                            viewBox="0 0 16 16"
                                        >
                                            <path fillRule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/>
                                            <path fillRule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/>
                                        </svg>
                                        &nbsp; Logout
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            </nav>
        </div>
    );
};

export default NavBarOrgAdmin;
